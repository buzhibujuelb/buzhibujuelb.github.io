---
title: 组合数学
date: 2019-8-16 23:16:05
tags: 
  - 组合数学
  - 计数
mathjax: true
categories: 总结
password: buzhibujue

---


# 组合数学


## Basic Formula
$$
\begin{aligned}
&m!{ n \brace m}\\
=&n!(e^x-1)^m[x^n]\\
=&n!\sum_{i=0}^me^{ix}(-1)^{m-i}\binom{m}{i}[x^n]\\
=&n!\sum_{i=0}^m\binom{m}{i}(-1)^{m-i}\sum_{j=0}^{\infinity}\frac{i^jx^j}{j!}[x^n]\\
=&\sum_{i=0}^m\binom{m}{i}(-1)^{m-i}i^n\\
\end{aligned}
\\
\Updownarrow\\
n^m=\sum_{i=0}^n{m\brace i}n^{\underline i}\\
\\
{n\brace m}=\sum_{i=0}^m\frac{(-1)^{m-i}i^n}{i!(m-i)!}\\
f(S)=\sum_{T\subseteq S}\sum_{p\subseteq T}(-1)^{|T|-|P|}f(P)
$$

$$
\begin{array}{}
m^n=&\sum_{i=1}^m{n\brace i}m^{\underline i}&&&&容斥\\
m^{\underline n}=&\sum_{i=1}^n{n\brack i}(-1)^{n-i}m^i&&&&定义\\
\end{array}
$$

$$
x^{\underline n}=(-1)^n(-x)^{\overline n}\\
x^{\overline n}=(-1)^n(-x)^{\underline n}\\
$$

$$
\sum_{i=0}^n(-1)^{n-i}{n\brack i}{i\brace m}=[m=n]\\
\sum_{i=0}^n(-1)^{n-i}{n\brace i}{i\brack m}=[m=n]
$$

证明:

$$
\begin{aligned}
 m^{n} &=\sum_{i=0}^{n}
{n\brack i}
(-1)^{n-i} m^{i} 
\\&=
\sum_{i=0}^{n}
{n\brack i}
(-1)^{n-i} \sum_{j=0}^{i}
{i\brace j}
 m^{j}
\\&=
\sum_{i=0}^{n} m^{i} \sum_{j=i}^{n}(-1)^{n-j}
{n\brack j}
{j\brace i}
\end{aligned}
$$

另一个证明同理

#### 斯特林反演：
$$
f(n)=\sum_{i=0}^n{n\brace i}g(i)
\Leftrightarrow
g(n)=\sum_{i=0}^n(-1)^{n-i}{n\brack i}f(i)
$$

证明：

已知 $g(n)=\sum_{i=0}^n{n\brace i}f(i)$

$$
\begin{aligned}
f(n)&=
\sum_{i=0}^n[i=n]f(i)
\\&=
\sum_{i=0}^nf(i)
\sum_{j=0}^n(-1)^{n-j}{n\brack j}{j\brace i}\\
\\&=
\sum_{j=0}^n(-1)^{n-j}{n\brack j}
\sum_{i=0}^nf(i){j\brace i}
\\&=
\sum_{j=0}^n(-1)^{n-j}{n\brack j}
g(j)
\end{aligned}
$$

另一个证明同理

应用：

$$
f(n)=x^n=\sum_{i=1}^n{n \brace i}x^{\underline i}=\sum_{i=1}^n{n \brace i}g(i)\\
\Updownarrow\\
g(n)=x^{\underline{n}}=\sum_{i=1}^n(-1)^{n-i}{n \brack i}f(i)=\sum_{i=1}^n(-1)^{n-i}{n \brack i}x^i\\
$$

$$
f(n)=x^{\overline n}=\sum_{i=1}^n{n \brack i}x^i=\sum_{i=1}^n{n \brack i}g(i)\\
\Updownarrow\\
g(n)=x^n=\sum_{i=1}^n(-1)^{n-i}{n \brace i}f(i)=\sum_{i=1}^n(-1)^{n-i}{n \brace i}x^{\overline i}\\
$$

----

### 第一类斯特林数求行(**OGF**形式)

已知 $F(x)=\sum_{i=0}f_ix^i$ 求 $F(x+n)$
$$
\begin{aligned}
&F(x+n)
\\=&
\sum_{i=0}f_i(x+n)^i
\\=&
\sum_{i=0}f_i\sum_{j=0}^i\binom{i}{j}x^jn^{i-j}
\\=&
\sum_{i=0}f_i\sum_{j=0}\binom{i}{j}x^jn^{i-j}
\\=&
\sum_{i=0}f_i\sum_{j=0}\frac{i!}{j!(i-j)!}x^jn^{i-j}
\\=&
\sum_{j=0}f_j\sum_{i=0}\frac{j!}{i!(j-i)!}x^in^{j-i}
\\=&
\sum_{i=0}\sum_{j=0}f_j\frac{j!}{(j-i)!}n^{j-i}\frac{x^i}{i!}
\\=&
\sum_{i=0}\frac{\left(\sum_{j=0}f_jj!\frac{n^{j-i}}{(j-i)!}\right)}{i!}x^i

\end{aligned}
$$
将 $A(x)=\sum_{i=0}\frac{n^i}{i!}$ 翻转一下再卷上 $B(x)=\sum_{i=0}f_ii!$ 再除以 $i!$ 即可

对应到第一类斯特林数就是 $\sum_{i=0}^n{n\brack i}x^i=x^{\overline n}=x^{\overline{n/2}}\cdot (x+n/2)^{\overline{n/2}}$ 。使用倍增解决

---

### 第一类斯特林数求列（**EGF**形式）

有且仅有一个圆排列的 $EGF$ 为
$$
f(x)=\sum_{i=1}^\infinity \frac{(i-1)!x^i}{i!}=\sum_{i=1}^\infinity\frac{x^i}{i}=\ln(\frac{1}{1-x})
$$
所以恰好 $k$ 个有标号圆排列的 $EGF$ 为 $f(x)^k=\left(\ln(\frac{1}{1-x})\right)^k$

第一类斯特林数是无标号的所以其对应的 $EGF$ 还要除以 $k!$
$$
\frac{\left(\ln(\frac{1}{1-x})\right)^k}{k!}=\frac{\left(\ln(1-x)\right)^k(-1)^k}{k!}=\sum_{i=0}^\infinity\frac{ {i\brack k}x^i}{i!}
$$
尝试从结论倒推能推出什么：把所有 $x$ 看作 $-x$ 得到
$$
\frac{(\ln(1+x))^k}{k!}=(-1)^k\sum_{i=0}^\infinity\frac{ {i\brack k}(-x)^i}{i!}=\sum_{i=0}^\infinity(-1)^{k+i}{i\brack k}\frac{x^i}{i!}
$$
两边同时取所有项并乘上一个 $t^k$ 的系数
$$
\sum_{k=0}^\infinity t^k\frac{\left(\ln(1+x)\right)^k}{k!}
=\exp(t\ln(1+x))=(1+x)^t
$$
右边
$$
\begin{aligned}
&\sum_{k=0}^\infinity t^k\sum_{i=0}^\infinity(-1)^{k+i}{i\brack k}\frac{x^i}{i!}
\\=&
\sum_{i=0}^\infinity t^i\sum_{k=0}^\infinity(-1)^{k+i}{k\brack i}\frac{x^k}{k!}
\\=&
\sum_{k=0}^\infinity\frac{x^k}{k!}\sum_{i=0}^\infinity t^i(-1)^{k+i}{k\brack i}
\\=&
\sum_{k=0}^\infinity\frac{x^k}{k!}t^{\underline k}
\\=&
\sum_{k=0}^\infinity x^k\binom{t}{k}
\\=&
(1+x)^t
\end{aligned}
$$

于是倒着推也是可以推出答案式子的

注意``ln``之后常数项为 $0$ 不能``qpow``的时候直接``return exp(ln(f)*k)``，要提前去掉末尾 $0$

---

### 第二类斯特林数求行（**OGF**形式）

$$
{n\brace m}=\frac{1}{m!}\sum_{i=1}^m\binom{m}{i}(-1)^{m-i}i^n=
\frac{n!}{m!}\sum_{i=1}^m\frac{i^n}{i!}\frac{(-1)^{m-i}}{(m-i)!}
$$

---

### 第二类斯特林数求列（**EGF**形式）

$$
{ n \brace m}=\frac{n!}{m!}(e^x-1)^m[x^n]\\
\begin{aligned}
&\sum_{i=0}^\infinity \frac{ {i\brace m}x^i}{i!}
\\=&
\sum_{i=0}^\infinity \frac{\left(\frac{i!}{m!}(e^x-1)^m[x^i]\right)x^i}{i!}
\\=&
\frac{1}{m!}\sum_{i=0}^\infinity(e^x-1)^m[x^i]x^i
\\=&
\frac{1}{m!}(e^x-1)^m
\end{aligned}
$$

也可以用和第一类求列相类似的推导，注意 $e^x-1$ 常数项系数为 $0$ ，``qpow``时同第一类求列都要特殊处理

---

### CF 932 E

$$
\begin{aligned}
&\sum_{i=1}^n\binom{n}{i}i^k\\
=&\sum_{i=1}^n\binom{n}{i}\sum_{j=0}^{i}{k\brace j}i^{\underline j}\\
=&\sum_{i=1}^n\binom{n}{i}\sum_{j=0}^{i}{k\brace j}\binom{i}{j}j!\\
=&\sum_{j=0}^{n}{k\brace j}j!\sum_{i=j}^n\binom{n}{i}\binom{i}{j}\\
=&
\sum_{j=0}^{n}{k\brace j}j!\sum_{i=j}^n\binom{n}{j}\binom{n-j}{n-i}\\
=&
\sum_{j=0}^{\min(n,k)}{k\brace j}\binom{n}{j}j!\sum_{i=0}^{n-j}\binom{n-j}{n-i-j}\\
=&
\sum_{j=0}^{\min(n,k)}{k\brace j}\binom{n}{j}j!2^{n-j}\\
=&
\sum_{j=0}^{\min(n,k)}{k\brace j}n^{\underline j}2^{n-j}\\

\end{aligned}
$$

---

### HEOI2016 求和
$$
\begin{aligned}
&\sum_{i=0}^n\sum_{j=0}^i{i\brace j}2^jj!\\
=&
\sum_{i=0}^n\sum_{j=0}^n{i\brace j}2^jj!\\
=&
\sum_{i=0}^n\sum_{j=0}^n2^jj!\sum_{k=0}^j\frac{1}{j!}(-1)^{j-k}\binom{j}{k}k^i\\
=&
\sum_{i=0}^n\sum_{j=0}^n2^j\sum_{k=0}^j(-1)^{j-k}\binom{j}{k}k^i\\
=&
\sum_{k=0}^n\sum_{j=k}^n2^j(-1)^{j-k}\binom{j}{k}\sum_{i=0}^nk^i\\
=& 
\sum_{k=0}^n\sum_{j=k}^n2^j(-1)^{j-k}\binom{j}{k}\frac{1-k^{n+1}}{1-k}\\
=&
\sum_{k=0}^n\sum_{j=0}^n2^j(-1)^{j-k}\frac{j!}{k!(j-k)!}\frac{1-k^{n+1}}{1-k}\\
=&
\sum_{j=0}^n2^jj!\sum_{k=0}^n(-1)^{j-k}\frac{1}{k!(j-k)!}\frac{1-k^{n+1}}{1-k}\\
=&
\sum_{j=0}^n2^jj!\sum_{k=0}^n\frac{(-1)^{j-k}}{(j-k)!}k!\frac{1-k^{n+1}}{1-k}\\
\end{aligned}
$$

（可优化到线性，见 200415 T3）

---

### FJOI2016 建筑师

$$
f[i][j]=f[i-1][j-1]+f[i-1][j]\times (i-1)\\
f[n][0]=[n=0]\\
f[n][1]=(n-1)!\\
f[i][j]={i\brack j}\\
ans=\sum_{i=1}^n{i-1\brack a-1}{n-i\brack b-1}\binom{n-1}{i-1}\\
n-1个数里选若干个组成 a-1个环，剩下的再组成b-1个环\\
即一共组成a+b-2个环每种组成a+b-2个环的方式被算了\binom{a+b-2}{a-1}次\\
={n-1\brack a+b-2}\binom{a+b-2}{a-1}
$$

---

### P4827 Crash 的文明世界

$$
\begin{aligned}
S(i)&=\sum_{j=1}^ndis(i,j)^k\\
&令d=dis(i,j)\\
&=
\sum_{j=1}^n\sum_{l=1}^{k}d^{\underline l}{k\brace l}\\
&=
\sum_{j=1}^n\sum_{l=1}^{k}\binom{d}{l}l!{k\brace l}\\
&=
\sum_{l=1}^{k}l!{k\brace l}\sum_{j=1}^n\binom{d}{l}\\
&=
\sum_{l=1}^kl!{k\brace l}\sum_{j=1}^n{\color{red}\binom{d-1}{l}+\binom{d-1}{l-1}}
\end{aligned}
$$

---

### BZOJ3622 已经没有什么好害怕的了

$ans[i]$ 表示恰有 $i$ 组 $A$ 比 $B$ 多的方案数
$f[i]$ 表示至少 $i$ 组 $A$ 比 $B$ 多的方案数
$$
f[i]=\sum_{j=i}^nans[j]\binom{j}{i}\\
ans[i]=\sum_{j=i}^nf[j](-1)^{j-i}\binom{j}{i}\\
$$
$dp[i][j][0/1]$ 表示前 $i$ 小的数，已经配了 $j$ 对 $A>B$ 现在左边是否还有没配对的 $B$ 的方案数

对于 $val[i]\in A$ $dp[i-1][j-1][1]\to dp[i][j][0]$

对于 $val[i]\in B$ $dp[i-1][j][0]\to dp[i][j][1]$

剩下的随便配对即 $f[i]=dp[2n][i][0]\times (n-i)!$

**上面的dp是错误的，其并不能算出至少 $i$ 对的方案数因为会有一些时候的”前缀未配对B个数”大于1**

比如配对 $1(B)\ 2(B)\ 3(A)\ 4(A)$ 时配 $2$ 对时会算出 $0$ 实际上是 $2$

应记录对于每个 $a_i$ 有多少个 $b_j$ 小于它,记为 $val[i]$ 则记 $f[i][j]$ 为前 $i$ 个点，硬点了 $j$ 个连比他小的边，**剩下的不连**，的方案数。转移就是
$$
dp[i][j]=dp[i-1][j]+dp[i-1][j-1]\times(val[i]-j+1)
$$

注意到这个转移恰好不重不漏的计算了至少 $j$ 个大到小的边的情况，至于剩下的 $n-j$ 条边可以任意连，答案就是
$$
ans_k=\sum_{i=0}^n(-1)^{i-k}\binom{i}{k}dp_{n,i}(n-i)!
$$

---

### P4002 生成树计数

$$
\begin{aligned}
ans&=
\sum_{d}
\left(\prod_{i=1}^n(d_i+1)^m\right)
\left(\sum_{i=1}^n(d_i+1)^m\right)
\binom{n-2}{d_1,d_2,d_3,\cdots d_n}
a_i^{d_i+1}
\\&=
\sum_{d}
\frac{(n-2)!}{d_1!d_2!\cdots d_n!}
\left(\prod_{i=1}^n(d_i+1)^m\right)
a_i^{d_i+1}
\left(\sum_{i=1}^n(d_i+1)^m\right)
\\&=
(n-2)!
\left(
\prod_{i=1}^na_i
\right)
\sum_d
\left(
\prod_{i=1}^n\frac{ {a_i}^{d_i}}{d_i!}(d_i+1)^m
\right)
\left(
\sum_{i=1}^n(d_i+1)^m
\right)
\\&=
(n-2)!
\left(
\prod_{i=1}^na_i
\right)
\sum_d
\sum_{i=1}^n(d_i+1)^m
\prod_{j=1}^n\frac{ {a_j}^{d_j}}{d_j!}(d_j+1)^m
\\&=
(n-2)!
\left(
\prod_{i=1}^na_i
\right)
\sum_d
\color{red}
\sum_{i=1}^n(d_i+1)^{2m}
\frac{ {a_i}^{d_i}}{d_i!}
\prod_{j=1,j\neq i}^n\frac{ {a_j}^{d_j}}{d_j!}(d_j+1)^m
\end{aligned}
$$

构造
$$
\color{red}F(x)=\sum_{d=0}^\infinity\frac{x^d(d+1)^{2m}}{d!}\\
\color{red}G(x)=\sum_{d=0}^\infinity\frac{x^d(d+1)^{m}}{d!}\\
$$
则 $F(a_ix)=\sum_{d=0}^\infinity\frac{(a_ix)^d(d+1)^{2m}}{d!}=\sum_{d=0}^\infinity\frac{a_i^d}{d!}(d+1)^{2m}x^d$

即得 
$$
\begin{aligned}
ans&=\sum_{i=1}^n
\left(
F(a_ix)
\prod_{j=1,j\neq i}^n
G(a_jx)
\right)
[x^{n-2}]
\\&=\sum_{i=1}^n
\left(
\frac{F(a_ix)}{G(a_ix)}
\prod_{j=1}^n
G(a_jx)
\right)
[x^{n-2}]
\\&=
\left(
\sum_{i=1}^n
(\frac{F}{G})(a_ix)
\right)
\left(
\prod_{i=1}^nG(a_ix)
\right)
[x^{n-2}]
\\&=
\left(
\sum_{i=1}^n
(\frac{F}{G})(a_ix)
\right)
e^{
\left(
\sum_{i=1}^n\ln(G(a_ix))
\right)
}
[x^{n-2}]
\end{aligned}
$$
已知一个函数各项系数 $H(x)=\sum_{i=0}^\infinity h(i)x^i$ 求 $\sum_{i=1}^n H(a_ix)$ ：
$$
\begin{aligned}
\sum_{i=1}^nH(a_ix)
&=
\sum_{i=1}^n\sum_{j=0}^\infinity h_j(a_ix)^j
\\&=
\sum_{i=1}^n\sum_{j=0}^\infinity h_ja_i^jx^j
\\&=
\sum_{j=0}^\infinity\left( \sum_{i=1}^n a_i^j\right)h_jx^j
\end{aligned}
$$
#### 如何快速求 $\sum_{i=1}^n a_i^k$ ：

$$
\begin{aligned}
ans(x)
&=
\sum_{k=0}^\infinity
\sum_{i=1}^n a_i^k x^k
\\&=
\sum_{i=1}^n
\sum_{k=0}^\infinity
a_i^k x^k
\\&=
\sum_{i=1}^n
\sum_{k=0}^\infinity
(a_ix)^k
\\&=
\sum_{i=1}^n
\frac{1}{1-a_ix}

\\&=
\sum_{i=1}^n
f_i(x)
\end{aligned}
$$
然后考虑构造一个函数 $g_i(x)=\ln(1-a_ix)′=\frac{-a_i}{1-a_ix}=\frac{1}{x}\frac{1-a_ix-1}{1-a_ix}=\frac{1}{x}(1-f_i(x))$
$$
\begin{aligned}
ans(x)&=\sum_{i=1}^nf_i(x)
\\&=
\sum_{i=1}^n
\left(
1-xg(x)
\right)
\\&=
n-
\left(\sum_{i=1}^ng_i(x)\right)x
\\
\sum_{i=1}^ng_i(x)&=
\sum_{i=1}^n
\ln(1-a_ix)′
\\&=
\left(
\sum_{i=1}^n
\ln(1-a_ix)
\right)′
\\&=
\ln
\left(
\prod_{i=1}^n(1-a_ix)
\right)′
\end{aligned}
$$

**另解：** $O(nm\log^2 n)$

令 $d_i$ 表示 $i$ 在``prufer``序列前 $n-2$ 项的出现次数，有
$$
\begin{aligned}
ans&=\sum_{d}\left(\sum_{i=1}^nd_i^m\right)\prod_{i=1}^n{a_i}^{d_i+1}\cdot d_i^m
\\&=
\sum_{d}\sum_{i=1}^nd_i^{2m}a_i^{d_i+1}\prod_{j=1,j\neq i}^nd_j^m{a_j}^{d_j+1}
\end{aligned}
$$

考虑其组合意义即对于一个``prufer``序列我们在它后面再添上 $1\sim n$ 使得每个数恰好出现其度数次，然后我们可以把 $d_i^m$ 看成对 $i=1\sim n$ 的每个颜色的 $d_i$ 个位置染 $m$ 次色，且这 $m$ 次染色可以染到同一位置的方案数。然后上面式子的意思就是一共有且仅有一个数 $i$ 被染了 $2m$ 次，其他的都被染了 $m$ 次，问最后的方案乘上改方案对应的权值（ $a_i^{d_i+1}$ ）的值

注意到 $m$ 比较小可以枚举这 $m/2m$ 次染色一共染了几个不同的位置，比如染了 $k$ 个指定的位置时方案数即为 ${m\brace k}k!$

然后 $f[i][j]$ 表示数字 $1,i$ 都只染了 $m$ 次，一共占了``prufer``序列的 $j$ 个位置时的只考虑染了色的位置时的总权值

$g[i][j]$ 表示数字 $1,i$ 中有且仅有一个数染了 $2m$ 次（其余都是染 $m$ 次）一共占了``prufer``序列的 $j$ 个位置时的只考虑染了色的位置时的总权值

转移时考虑有没有染到后 $n$ 个中对应的那个位置得到
$$
\begin{array}{c}
{f_{i,j}=\sum_{k=0}^{m}f_{i-1,j-k}\left(\begin{array}{c}{n-2-(j-k)}\\{k}\end{array}\right)a_{i}^{k+1}({m\brace k}k!+{m\brace k+1}(k+1)!)}\\
{g_{i,j}=s1+s2}\\
{s1=\sum_{k=0}^{2m}f_{i-1,j-k}\left(\begin{array}{c}{n-2-(j-k)}\\{k}\end{array}\right)a_{i}^{k+1}({2m\brace k+1}k!+{2m\brace k+1}(k+1)!)}\\
{s2=\sum_{k=0}^{m}g_{i-1,j-k}\left(\begin{array}{c}{n-2-(j-k)}\\{k}\end{array}\right)a_{i}^{k+1}({m\brace k}k!+{m\brace k+1}(k+1)!)}
\end{array}
$$

$$
\begin{aligned}
f_j&=
\sum_{k=0}^mf'_{j-k}\frac{(n-2-(j-k))!}{k!(n-2-j)!}a_i^{k+1}\left({m\brace k}k!+{m \brace k+1}(k+1)!\right)
\\&=
\frac{1}{(n-2-j)!}\sum_{k=0}^m\left(a_i^{k+1}\left({n\brace k}+(k+1){m \brace k+1}\right)\right)\left(f'_{j-k}\times(n-2-(j-k))!\right)\\

\end{aligned}
$$
$$
\begin{aligned}
令F_j&=f_j\times(n-2-j)!\\
F_j&=\sum_{k=0}^m\left(a_i^{k+1}\left({n\brace k}+(k+1){m \brace k+1}\right)\right)F'_{j-k}\\
\end{aligned}
$$

**注意初值是 $f_0=1\to F_0=(n-2)!$ **

然后``分治ntt``的写法可以不管什么看上去是 $g_i=g_{i-1}*a_i+f_{i-1}*b_i$ 这样的东西不知道怎么推导

直接计算两边两个关于 $j$ 的多项式，一个 $g$ 表示有且仅有一个数字染了 $2m$ 次的方案，一个 $f$ 表示全部都只染了 $m$ 次，然后直接

 $f(l,r)=f(l,mid)*f(mid+1,r) \\ g(l,r)=g(l,mid)*f(mid+1,r)+f(l,mid)*g(mid+1,r)$ 

即可（注意只用最后 $n-1$ 项，最后 $ans=\sum_{i=0}^{n-2} g[i]\times (\sum_{j=1}^na[j])^i$ 即剩下的 $n-2-i$ 个空格任意填 $1\sim n$，每填一个 $j$ 则权值多乘上一个 $a_j$ ）

（ $1690ms:13615ms$ ）

---

### P3711 仓鼠的数学题

$$
\begin{aligned}
ans&=\sum_{k=0}^nS'_k(x)a_k
\\&=
\sum_{k=0}^n\left(S_k(n)+x^k\right)a_k
\\&=
\sum_{k=0}^nS_k(x)+\sum_{k=0}^nx^ka_k
\\&=
\sum_{k=0}^na_k\sum_{i=0}^k\frac{1}{i+1}\binom{k}{i}x^{i+1}B_{k-i}+\sum_{k=0}^nx^ka_k
\\&=
\sum_{k=0}^na_k\sum_{i=0}^n\frac{1}{i+1}\binom{k}{i}x^{i+1}B_{k-i}+\sum_{k=0}^nx^ka_k
\\&=
\sum_{i=0}^nk!a_k!\frac{B_{k-i}}{(k-i)!}\frac{x^{i+1}}{(i+1)!}+\sum_{k=0}^nx^ka_k
\end{aligned}
$$

翻转后卷积即可

---

### CF 932 E严格加强

求 $\sum_{i=0}^m\binom{m}{i}f(i)$ 。其中 $f(i)$ 是一个关于 $i$ 的 $n$ 次多项式

先把 $f(x)$ 转成下降幂形式 $f(x)=\sum_{i=0}^n g_ix^{\underline i}$
$$
\begin{aligned}
&\sum_{i=0}^m\binom{m}{i}f(i)
\\=&
\sum_{i=0}^m\binom{m}{i}\sum_{j=0}^ng_ji^{\underline j}
\\=&
\sum_{i=0}^m\binom{m}{i}\sum_{j=0}^ng_j\binom{i}{j}j!
\\=&
\sum_{j=0}^ng_j\sum_{i=0}^m\binom{m}{i}\binom{i}{j}j!
\\=&
\sum_{j=0}^ng_j\sum_{i=0}^m\binom{m}{j}\binom{m-j}{m-i}j!
\\=&
\sum_{j=0}^ng_j\binom{m}{j}j!\sum_{i=0}^m\binom{m-j}{m-i}
\\=&
\sum_{j=0}^ng_j\binom{m}{j}j!2^{m-j}
\end{aligned}
$$

#### 如何转次幂为下降幂？

$$
f(x)=\sum_{i=0}^nf_ix^i=\sum_{i=0}^ng_ix^{\underline i}=\sum_{i=0}^ng_i\frac{x!}{(x-i)!}=\sum_{i=0}^xg_i\frac{x!}{(x-i)!}\\
\frac{f(x)}{x!}=\sum_{i=0}^xg_i\frac{1}{(x-i)!}
$$

令 $F(x)=\sum_{i=0}^\infinity \frac{f(i)}{i!}$ ，有 $F(x)=G(x)\cdot e^x\to G(x)=F(x)\cdot e^{-x}$

因为 $g$ 也是 $n$ 次多项式 只需多点求值求出所有 $f(i),i\in[0,n]$ 再除以 $i!$ 卷上 $e^{-x}$ 即可 （注意顺序）

---

### 2019 江苏省队集训D1T3 魔法咒语

已知 $g$ 且 $g_n=\sum_{i=0}^n\dbinom nif_i\iff f_n=\sum_{i=0}^n(-1)^{n-i}\dbinom nig_i$ 求 $\sum_{i=1}^n f_i$ 要求线性
$$
\begin{aligned}
&
\sum_{i=1}^nf_i
\\=&
\sum_{i=1}^n\sum_{j=0}^n(-1)^{i-j}\binom{i}{j}g_j
\\=&
\sum_{i=0}^ng_i\sum_{j=0}^n(-1)^{j-i}\binom{j}{i}
\\=&
\sum_{i=0}^ng_iw_i
\end{aligned}
$$

这个 $w_i$ 只和 $i$ 有关
$$
\begin{aligned}
w_m=&\sum_{i=0}^n(-1)^{i-m}\binom{i}{m}
\\=&
\sum_{i=0}^n(-1)^{i-m}\left(\binom{i-1}{m}+\binom{i-1}{m-1}\right)
\\=&
\sum_{i=0}^n(-1)^{i-m}\binom{i-1}{m}+\sum_{i=0}^n(-1)^{i-m}\binom{i-1}{m-1}
\\=&
\sum_{i=0}^n(-1)^{i-m}\binom{i-1}{m}+\sum_{i=0}^{n-1}(-1)^{i-m+1}\binom{i}{m-1}
\\=&
\sum_{i=0}^{n-1}(-1)^{i+1-m}\binom{i}{m}+\sum_{i=0}^{n-1}(-1)^{i-(m-1)}\binom{i}{m-1}
\\=&
-(\sum_{i=0}^{n}(-1)^{i-m}\binom{i}{m}-(-1)^{n-m}\binom{n}{m})+w_{m-1}-(-1)^{n-(m-1)}\binom{n}{m-1}
\\=&
-w_m+w_{m-1}+(-1)^{n-m}\binom{n}{m}+(-1)^{n-m}\binom{n}{m-1}
\end{aligned}
\\
$$

$$
\therefore
 w_m=\frac{w_{m-1}+(-1)^{n-m}\binom{n+1}{m}}{2}
$$

---

### 下降幂多项式乘法

$F(x)=\sum_{i=0}^nf_ix^{\underline{i}}$ 其点值的 $EGF$ 为

$$
\begin{aligned}
&
\sum_{i=0}^\infinity \frac{F(i)}{i!}x^i
\\=&
\sum_{i=0}^\infinity \frac{\sum_{j=0}^nf_ji^{\underline j}}{i!}x^i
\\=&
\sum_{i=0}^\infinity \sum_{j=0}^nf_j\frac{1}{(i-j)!}x^i
\end{aligned}
$$

即直接把 $f$ 卷上 $\sum_{i=0}^\infinity \frac{1}{i!}=e^x$ 即可得到点值的 $EGF$

两个下降幂的点值的 $EGF$ 对应项相乘再乘上多余的一个 $i!$ 以去掉两个同时作为 $EGF$ 的分母上的 $i!$ 即可得到答案的点值的 $EGF$

从点值 $EGF$ 求原下降幂多项式直接除以 $e^x$ 即乘上 $e^{-x}$ 即可

---

### P4389 付公主的背包

$$
\large
\begin{aligned}
&\prod_{i=1}^n\frac{1}{1-x^{a_i}}
\\=&
\exp\left(\sum_{i=1}^n\ln(\frac{1}{1-x^{a_i}})\right)
\\=&
\exp\left(\sum_{i=1}^n\sum_{j=1}^\infinity\frac{1}{j}(x^{a_i})^j\right)
\end{aligned}
$$

直接调和级数一样做即可

---

### 下降幂转次幂

下降幂转点值的 $EGF$ 直接乘上 $e^x$

再上个快速插值

#### 快速插值

$$
\begin{aligned}
f(x)&=\sum_{i=1}^n\frac{\prod_{j=1,j\neq i}^nx-x_j}{\prod_{j=1,j\neq i}^nx_i-x_j}y_i
\\&=
\sum_{i=1}^ny_i\frac{1}{\prod_{j=1,j\neq i}^nx_i-x_j}\prod_{j=1,j\neq i}^nx-x_j
\end{aligned}
$$

$$
\prod_{j=1,j\neq i}^nx-x_j=\frac{\prod_{j=1}^nx-x_j}{x-x_i}\\
\lim_{x\to x_i}\frac{\prod_{j=1}^nx-x_j}{x-x_i}
=\frac{(\prod_{j=1}^nx-x_j)'}{(x-x_i)'}=(\prod_{j=1}^nx-x_j)'\mid _{x=x_i}
$$

使用多点求值得到每个 $i$ 的 $(\prod_{j=1}^nx-x_j)'\mid _{x=x_i}$

 然后每一项的常数项即为 $\frac{y_i}{val_i}$ 再乘上 $\sum_{j=1,j\neq i}^nx-x_j$ 即``return tr[lk]*solve(l,mid)+tr[rk]*solve(mid+1,r);``

但这题可能会 $T$ 。。。 跑了36s

注意到 $x_i=i-1$ 所以 $\prod_{j=1,j\neq i}^nx_i-x_j=(i-n)(i-n+1)\cdots(-1)(1)(2)\cdots(i-1)=(-1)^{n-i}(n-i)!(i-1)!$

---

### WC2019 数树

 首先有 $ans=y^{|n-T1\bigcap T2|}$

#### type=0

直接求并大小

#### type=1

注意到有一个容斥式子 $\color{red}f(S)=\sum_{T\subseteq S}\sum_{P\subseteq T}(-1)^{|T|-|P|}f(P)$

证明：
$$
\begin{aligned}
右式=&
\sum_{P\subseteq S}f(P)\sum_{T'\subseteq S\oplus P}(-1)^{|T'|}
\\=&
\sum_{P\subseteq S}f(P)\sum_{szt=0}^{|S\oplus P|}\binom{|S\oplus P|}{szt}(-1)^{szt}
\\=&
\sum_{P\subseteq S}f(P)(1-1)^{|S\oplus P|}
\\=&
f(S)
\end{aligned}
$$


然后带入 $f(S)=y^{n-|S|}$ 无脑推式子
$$
\begin{aligned}

ans
=&
\sum_{T2}y^{n-|T1\bigcap T2|}

\\=&

\sum_{T2}\sum_{T\subseteq \left(T1\bigcap T2\right)}\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}

\\=&

\sum_{T\subseteq T1}g(T)\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}

\end{aligned}
$$

其中 $g(S)$ 表示含有边集 $S$ 的树有多少种

若 $S$ 形成 $k$ 个连通块 $a_1,a_2,\cdots a_k$ 则 $g(S)=n^{k-2}\prod_{i=1}^ka_i$

证明可以直接用行列式，这里写另一种

把每个已经确定的连通块看成一个点，然后直接用``prufer``序列，但是每一个连出去的边都有 $a_i$ 种连法,令``prufer``序列第 $i$ 个点为 $p_i$ ,令第 $i$ 个点在``prufer``序列里出现 $q_i$ 次，那么其度数为 $q_i+1$，得到

$$
\begin{aligned}

g(S)=&
\sum_{p_1,p_2,\cdots p_{k-2}}\prod_{i=1}^k a_i^{q_i+1}
\\=&
\left(\prod_{i=1}^k a_i\right)
\sum_{p_1,p_2,\cdots p_{k-2}}\prod_{i=1}^k a_i^{q_i}
\\=&
\left(\prod_{i=1}^k a_i\right)
\sum_{p_1,p_2,\cdots p_{k-2}}\prod_{i=1}^{k-2} a_{p_i}
\\=&
\left(\prod_{i=1}^k a_i\right)
\prod_{i=1}^{k-2}
\sum_{p_i=1,2,\cdots k}
 a_{p_i}
\\=&
\left(\prod_{i=1}^k a_i\right)
n^{k-2}

\end{aligned}
$$

若有 $|S|$ 条边，则连通块个数 $k=n-|S|$
$$
\begin{aligned}

ans
&=
\sum_{T\subseteq T1}g(T)\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}
\\&=
\sum_{T\subseteq T1}n^{k-2}\prod_{i=1}^ka_i\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}
\\&=
\sum_{T\subseteq T1}n^{k-2}\prod_{i=1}^ka_i\sum_{szp=0}^{|T|}\binom{|T|}{szp}(-1)^{|T|-szp}y^{n-szp}
\\&=
\sum_{T\subseteq T1}n^{k-2}\prod_{i=1}^ka_iy^{n-|T|}\sum_{szp=0}^{|T|}\binom{|T|}{szp}(-1)^{|T|-szp}y^{|T|-szp}
\\&=
\sum_{T\subseteq T1}n^{k-2}\left(\prod_{i=1}^ka_i\right)y^{n-|T|}(1-y)^|T|
\\&=
\sum_{T\subseteq T1}n^{k-2}\left(\prod_{i=1}^ka_i\right)y^{n-(n-k)}(1-y)^{n-k}
\\&=
\frac{(1-y)^n}{n^2}\sum_{T\subseteq T1}\left(\prod_{i=1}^ka_i\right)\left(\frac{ny}{1-y}\right)^k
\\&=
\frac{(1-y)^n}{n^2}\sum_{T\subseteq T1}\prod_{i=1}^k\frac{ny}{1-y}a_i
\end{aligned}
$$

令 $K=\frac{ny}{1-y}$ 相当于每个大小为 $a_i$ 的连通块对答案有 $Ka_i$ 的贡献

设 $f_{i,j}$ 表示以 $i$ 为根，包含 $i$ 的连通块大小为 $j$ 时，子树内所有情况下的答案（且不包含本身所在的连通块）

得到 $ans=\sum_{i}f_{rt,i}\times ki$ 

转移是 

$$
f_{u,i}\times \left(\sum_{j=1}^{sz_v}f_{v,j}\times K\times j\right)\to f_{u,i}\\
f_{u,i}\times f_{v,j}\to f_{u,i+j}\\
初值f_{u,1}=1
$$

现在已经可以 $O(n^2)$ 求解，考虑再优化

把 $f_u$ 看成是一个集合幂级数，则 $\sum_{i}f_{u,i}\times i=f'_u(1)$

令 $g_u=Kf'_u(1)=K\sum_{i}f_{u,i}\times i$

则

$$
\begin{aligned}
f_u(x)&=x\prod_{v\in son_u}f_v(x)+g_v\\

g_u
&=Kf'_u(1)
\\&=
K\left(x\prod_{v\in son_u}f_v(x)+g_v\right)'{\Large |}_{x=1}
\\&=
K\left(\prod_{v\in son_u}f_v(x)+g_v\right){\Large |}_{x=1}
+Kx
\left(
\prod_{v\in son_u}f_v(x)+g_v
\right)'{\Large |}_{x=1}
\\&=
K\left(\prod_{v\in son_u}f_v(1)+g_v\right)
+Kx
\left(
\sum_{w\in son_u}\left(
f_w(x)+g_w\right)'
\prod_{v\in son_u,v\neq w}f_v(x)+g_v
\right){\Large |}_{x=1}
\\&=
K\left(\prod_{v\in son_u}f_v(1)+g_v\right)
+Kx
\left(
\sum_{w\in son_u}
f_w'(x)
\prod_{v\in son_u,v\neq w}f_v(x)+g_v
\right){\Large |}_{x=1}
\\&=
K\left(\prod_{v\in son_u}f_v(1)+g_v\right)
+Kx
\left(
\left(\prod_{v\in son_u}
f_v(x)+g_v
\right)
\sum_{w\in son_u}
\frac{f_w'(x)}{f_w(x)+g_w}
\right){\Large |}_{x=1}
\\&=
K\left(\prod_{v\in son_u}f_v(1)+g_v\right)
+x
\left(
\left(\prod_{v\in son_u}
f_v(x)+g_v
\right)
\sum_{w\in son_u}
\frac{Kf_w'(x)}{f_w(x)+g_w}
\right){\Large |}_{x=1}
\left(\right)

\\&=
K\left(\prod_{v\in son_u}f_v(1)+g_v\right)
+
\left(
\left(\prod_{v\in son_u}f_v(1)+g_v
\right)
\sum_{w\in son_u}
\frac{Kf_w'(1)}{f_w(1)+g_w}
\right)
\\&=
\left(\prod_{v\in son_u}f_v(1)+g_v\right)
\left(
K+
\sum_{w\in son_u}
\frac{Kf_w'(1)}{f_w(1)+g_w}
\right)
\\&=
\left(\prod_{v\in son_u}f_v(1)+g_v\right)
\left(
K+
\sum_{w\in son_u}
\frac{g_w}{f_w(1)+g_w}
\right)
\end{aligned}
$$

再令 $t_u=f_u(1)$ 即可得到

$$
\begin{aligned}
g_u&=
\left(\prod_{v\in son_u}f_v(1)+g_v\right)
\left(
K+
\sum_{w\in son_u}
\frac{g_w}{f_w(1)+g_w}
\right)
\\&=
\left(\prod_{v\in son_u}t_v+g_v\right)
\sum_{w\in son_u}
\frac{g_w}{t_w+g_w}
\\
t_u=f_u(1)&=
\left(x\prod_{v\in son_u}f_v(x)+g_v
\right){\Large |}_{x=1}\\
&=\prod_{v\in son_u}f_v(1)+g_v\\
&=\prod_{v\in son_u}t_v+g_v\\
\end{aligned}
$$

即可 $O(n)$ ``dp``了

#### type=2

$$
\begin{aligned}
ans&=
\sum_{T1}\sum_{T2}y^{n-|T1\bigcap T2|}
\\&=
\sum_{T1}\sum_{T2}\sum_{T\subseteq{(T1\cap T2)}}\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}
\\&=
\sum_{T}h(T)\sum_{P\subseteq T}(-1)^{|T|-|P|}y^{n-|P|}
\\&=
\sum_{T}h(T)\sum_{szp=0}^{|T|}\binom{|T|}{szp}(-1)^{|T|-szp}y^{n-szp}
\end{aligned}
$$

其中 $h(T)$ 是两个树都包含 $T$ 这个边集的方案数，且 $h(T)=g^2(T)=\left(n^{k-2}\prod_{i=1}^k a_i\right)^2=n^{2k-4}\prod_{i=1}^k a_i^2$
 （因为两棵树不等价，第一棵可以任选 $g(T)$ 中的一棵，第二棵也是）

所以带入得到

$$
\begin{aligned}

ans&=
\sum_{T}h(T)\sum_{szp=0}^{|T|}\binom{|T|}{szp}(-1)^{|T|-szp}y^{n-szp}

\\&=
\sum_{T}h(T)y^{n-|T|}\sum_{szp=0}^{|T|}\binom{|T|}{szp}(-1)^{|T|-szp}y^{|T|-szp}
\\&=
\sum_{T}h(T)y^{n-|T|}
(1-y)^|T|
\\&=
\sum_{T}
\left(
n^{2k-4}\prod_{i=1}^k a_i^2
\right)
y^{n-|T|}(1-y)^{|T|}
\\&=
\frac{1}{n^4}
\sum_{T}
n^{2k}
\left(
\prod_{i=1}^k a_i^2
\right)
y^{n-(n-k)}(1-y)^{n-k}
\\&=
\frac{(1-y)^n}{n^4}
\sum_{T}
\left(
\prod_{i=1}^k a_i^2
\right)
\left(
\frac{n^2y}{1-y}
\right)^{k}
\\&=
\frac{(1-y)^n}{n^4}
\sum_{T}
\prod_{i=1}^k 
\frac{n^2y}{1-y}
a_i^2
\\
\end{aligned}
$$

> 对于一个确定点数为 $a_i$ 的树，共有 $a_i^{a_i-2}$ 种形式
> 
> 把 $n$ 个点分成 $k$ 个有标号且大小分别为 $a_1,a_2,\cdots a_k$ 的连通块的方案是 $\binom{n}{a_1,a_2\cdots a_k}$

则把 $n$ 个点分成 $k$ 个无标号且大小分别为 $a_1,a_2,\cdots a_k$ 的连通块的方案是 $\frac{1}{k!}\binom{n}{a_1,a_2\cdots a_k}$

$$
\begin{aligned}
\\&=
\frac{(1-y)^nn!}{n^4}
\sum_{\tiny\begin{aligned}&a_1,a_2,\cdots a_k\\&a_1+a_2+\cdots a_k=n\end{aligned}}
\frac 1{k!}
\prod_{i=1}^k
\frac 1{a_i!}
a_i^{a_i-2}
\times
\frac{n^2y}{1-y}
 a_i^2
\\&=
\frac{(1-y)^nn!}{n^4}
\sum_{\tiny\begin{aligned}&a_1,a_2,\cdots a_k\\&a_1+a_2+\cdots a_k=n\end{aligned}}
\frac{1}{k!}
\prod_{i=1}^k
\frac{1}{a_i!}
\frac{n^2y}{1-y}
a_i^{a_i}
\\&=
\frac{(1-y)^nn!}{n^4}
\sum_{\tiny\begin{aligned}&a_1,a_2,\cdots a_k\\&a_1+a_2+\cdots a_k=n\end{aligned}}
\frac{1}{k!}
\prod_{i=1}^k
\frac{1}{a_i!}
\frac{n^2y}{1-y}
a_i^{a_i}
\\&=
\frac{(1-y)^nn!}{n^4}
\sum_{k=0}^\infinity
\frac{1}{k!}
\left(
\sum_{i=0}^\infinity
\frac{1}{i!} \frac{n^2}{1-y}i^i x^i
\right)^k
[x^n]
\\&=
\frac{(1-y)^nn!}{n^4}
\exp
\left(
\sum_{i=0}^\infinity
\frac{1}{i!} \frac{n^2}{1-y}i^i x^i
\right)
[x^n]
\end{aligned}
$$

令一种理解上式的方法：

> 一个大小为 $a$ 的树的权值为 $\frac{n^y}{1-y}a^a$
>
> 一个森林的权值为里面所有树的权值之积
>
> 求所有森林的权值之和

所以直接 ``exp`` 就行了

---

### CodeChef PSUM

$$
(A+B)^k=\sum_{i=0}^k \binom{k}{i}A^iB^{k-i}\\
\sum_{A\in S}(A+B)^k=\sum_{A\in S}\sum_{i=0}^k \binom{k}{i}A^iB^{k-i}
=\sum_{i=0}^k \binom{k}{i}(\sum_{A\in S}A^i)B^{k-i}
\\
$$

$$
f[i][j][x]=f[i-1][j][x]+

\sum_{k=0}^x\binom{x}{k}f[i-1][j-C_i][k]\times (C_i)^{x-k}\\
f_{i,j}[x^k]=f_{i-1,j}+k!\times \sum_{t=0}^k \frac{(C_i)^{k-t}}{(k-t)!}\times\frac{f_{i-1,j-C_i}[x_t]}{t!}
$$

``NTT``卷积优化``dp``即可

---

### BZOJ5093 图的价值 

$$
\begin{aligned}
ans
&=\sum_{E}\sum _{u=1}^n deg[u]^k\\
&=n\sum_{E}deg[1]^k\\
&=n\sum_{E}\sum_{d=1}^{n-1}d^k[deg[1]=k]\\
&=n\sum_{d=1}^{n-1}d^k\binom{n-1}{d}2^{\binom{n}{2}-(n-1)}\\
&=n2^{\binom{n}{2}-(n-1)}
\sum_{d=1}^{n-1}d^{n-1}\binom{n-1}{d}\\

&=n2^{\binom{n}{2}-(n-1)}\sum_{d=1}^k
\binom{n-1}{d}\sum_{i=1}^{d}{k\brace i}\binom{d}{i}i!
\\

&=n2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}
{k\brace i}i!\sum_{d=1}^{n-1}\binom{n-1}{d}\binom{d}{i}
\\
&=n2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}
{k\brace i}i!\sum_{d=1}^{n-1}\binom{n-1}{i}\binom{n-1-i}{n-1-d}
\\
&=n2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}
{k\brace i}i!\binom{n-1}{i}\sum_{d=1}^{n-1}\binom{n-1-i}{n-1-d}
\\
&=n2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}
{k\brace i}i!\binom{n-1}{i}2^{n-1-i}
\\
&=2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}{k\brace i}\frac{2^{n-1-i}\times n!}{(n-1-i)!}
\\
&=2^{\binom{n}{2}-(n-1)}\sum_{i=1}^{n-1}{k\brace i}2^{n-1-i}\times n^{\underline{i+1}}
\end{aligned}
$$

算出第二类斯特林数后直接``for``一遍即可

---

### 分布

方差 $Var(X)$ 和 $E(X^2)$ 的关系

$$
\begin{aligned}
Var(X)&=E((X-E(X))^2)
\\&=
E(X^2+E^2(X)-2xE(X))
\\&=
E(X^2)+E(E^2(X))-E(2xE(X))
\\&=
E(X^2)+E^2(X)-2E(X)E(X)
\\&=
E(X^2)-E^2(X);
\end{aligned}
$$

#### 伯努利分布

一个变量 $X$ 有 $p$ 的概率为 $1$ ， $1-p$ 的概率为 $0$

则
$$
E(X)=1*p+0*(1-p)=p\\
E(X^2)=1^2p+0^2(1-p)=p\\
Var(X)=E(X^2)-E^2(X)=p-p^2=p(1-p)\\
$$


#### 二项式分布

二项分布是 $n$ 个独立的是/非试验中成功的次数的离散概率分布，其中每次试验的成功概率为 $p$

> 注：以下记 $q=1-p$

由定义可得每次成功与否是独立的，可得 $E(X)=E(1)+E(2)+\cdots E(n)=p+p+\cdots p=np$

或者组合意义下证明

$$
\begin{aligned}
E(X)&=\sum_{i=0}^ni\binom{n}{i}p^iq^{n-i}
\\&=
\sum_{i=0}^ni\times \frac{n}{i}\times p\binom{n-1}{i-1}p^{i-1}q^{n-i}
\\&=
np\sum_{i=0}^n\binom{n-1}{i-1}p^{i-1}q^{n-i}
\\&=
np\sum_{i=0}^{n-1}\binom{n-1}{i}p^iq^{n-1-i}
\\&=
np(p+q)^{n-1}
\\&=
np
\end{aligned}
$$

$E(x)^2$ 有点难搞，因为 $E(X^2)=E(X^2-X+X)=E(X(X-1)+X)=E(X(X-1))+E(X)$ 根据上面的类似推一下 $E(X(X-1))$

$$
\begin{aligned}
E(X(X-1))&=\sum_{i=0}^ni(i-1)\binom{n}{i}p^iq^{n-i}
\\&=
\sum_{i=0}^ni(i-1)\times\frac{n(n-1)}{i(i-1)}\times p^2\binom{n-2}{i-2}p^{i-2}q^{n-i}
\\&=
n(n-1)p^2\sum_{i=0}^n\binom{n-2}{i-2}p^{i-2}q^{n-i}
\\&=
n(n-1)p^2\sum_{i=0}^{n-2}\binom{n-2}{i}p^iq^{n-2-i}
\\&=
n(n-1)p^2(p+q)^{n-2}
\\&=
n(n-1)p^2
\end{aligned}
$$

所以 $Var(X)=E(X^2)-E^2(X)=n(n-1)p^2+np-(np)^2=np-np^2=npq$

同时类似的可以得到 $E(x^{\underline a})=n^{\underline a}\times p^a$

---

### UOJ269 如何优雅地求和

**这道16年的题给了点值，现在看上去很明显，实际上应该要能自己想出来最重要的一步即转成下降幂**

设 $f(x)=\sum_{i=0}^{m}g_ix^{\underline i}$

$$
\begin{aligned}
ans&=
\sum_{k=0}^nf(k)\binom{n}{k}x^k(1-x)^{n-k}
\\&=
\sum_{k=0}^n\sum_{j=0}^mg_jk^{\underline j}\binom{n}{k}x^k(1-x)^{n-k}
\\&=
\sum_{j=0}^mg_j\sum_{k=0}^nk^{\underline j}\binom{n}{k}x^k(1-x)^{n-k}
\\&=
\sum_{j=0}^mg_j\sum_{k=0}^nk^{\underline j}\frac{n^{\underline j}}{k^{\underline j}}x^j\binom{n-j}{k-j}x^{k-j}(1-x)^{n-k}
\\&=
\sum_{j=0}^mg_jx^jn^{\underline j}\sum_{k=0}^n\binom{n-j}{k-j}x^{k-j}(1-x)^{n-k}
\\&=
\sum_{j=0}^mg_jx^jn^{\underline j}(x+(1-x))^{n-j}
\\&=
\sum_{j=0}^mg_jx^jn^{\underline j}
\end{aligned}
$$

注意点值转下降幂的公式中，哪里要除以阶乘哪里乘阶乘要想清楚!

---

### cf961G Partitions

$ans=\left(\sum w\right)Sum$

$$
\begin{aligned}
Sum
&=
{\color{red}
\sum_{i=0}^{n-1}(i+1)\binom{n-1}{i}{n-1-i\brace k-1}}
\\&=
\sum_{i=0}^{n-1}(i+1)\binom{n-1}{i}\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}j^{n-1-i}\binom{k-1}{j}
\\&=
\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}\sum_{i=0}^{n-1}(i+1)\binom{n-1}{i}j^{n-1-i}


\\&=

\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}\left(
\sum_{i=0}^{n-1}i\binom{n-1}{i}j^{n-1-i}
+
\sum_{i=0}^{n-1}\binom{n-1}{i}j^{n-1-i}
\right)
\\&=

\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}\left(\left(
(n-1)\sum_{i=0}^{n-1}\binom{n-2}{i-1}j^{n-1-i}\right)
+
(1+j)^{n-1}
\right)
\\&=
\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}\left(
(n-1)\left(
\sum_{i=0}^{n-2}\binom{n-2}{i}j^{n-2-i}\right)
+
(1+j)^{n-1}
\right)
\\&=
\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}\left(
(n-1)
(1+j)^{n-2}
+
(1+j)^{n-1}
\right)
\\&=
\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}
(1+j)^{n-2}\left((n-1)+(1+j)\right)
\\&=
\frac{1}{(k-1)!}\sum_{j=0}^{k-1}(-1)^{k-1-j}\binom{k-1}{j}
(1+j)^{n-2}\left(n+j\right)
\\&=
\sum_{j=0}^{k-1}(-1)^{k-1-j}\frac 1{j!}\frac 1{(k-1-j)!}
(1+j)^{n-2}\left(n+j\right)
\end{aligned}
$$

然后直接做即可，也可以用线性筛去掉快速幂的 $\log$ （注意 $j$ 是``0 base``的）（实际上第一行的式子已经可以直接做了，只是模数比较恶心…）

或者从组合意义上考虑：

一个点被算进 $Sum$ ，只可能是

1. 自己对自己的贡献，这个的方案数是 $n\brace k$

2. 加入了其他已经分成 $k$ 份中的一份集合时同集合的点对其的贡献，考虑 $n-1$ 个点分成 $k$ 份的所有划分，每一种划分中当前点都可以加入划分出的 $k$ 个集合的任意一个，加入的集合中的每一个别的点都对 $Sum$ 有 $1$ 的贡献，当前点一共有 $k$ 种选取集合的方法，每个集合的点数加起来是 $n-1$ 

于是有

$Sum={n\brace k}+(n-1){n-1\brace k}$

求第二类斯特林数的一项还是要更简单一些 ${n\brace m}=\frac 1{m!}\sum_{i=0}^m(-1)^{m-i}\binom{m}{i}i^n$ 同样扫一遍即可（同样可用线筛去掉快速幂的 $\log$）

---
### HDU6042 Journey with Knapsack

$ans=\sum_{i=0}^nf_{2n-b_i}$

$$
\begin{aligned}
f(x)&=(1+x+x^2+\cdots +x^{a_1})(1+x^2+x^4+\cdots +x^{a_2})\cdots(1+x^n+x^{2n}+\cdots +x^{a_n})
\\&=
\prod_{i=1}^n(1+x^i+x^{2i}+\cdots x^{a_ii})
\\&=
\prod_{i=1}^n\frac{1-x^{(a_i+1)i}}{1-x^i}
\\&=
\prod_{i=1}^n(1-x^{(a_i+1)i})\prod_{i=1}^n\frac{1}{1-x^i}
\end{aligned}
$$

因为我们最终需要 $f$ 的 $0\sim 2n$ 项的系数，上式的后半部分在 $0\sim n$ 次项的系数是拆分数 $p$ 可以在 $O(n\sqrt n)$ 算出，但在 $n+1\sim 2n$ 次项的系数就是只用 $1\sim n$ 组合的方案不好搞，**因此我们尝试把边界扩大到** $2n$

$$
\begin{aligned}
&\prod_{i=1}^n1-x^{(a_i+1)i}\prod_{i=1}^n\frac{1}{1-x^i}
\\=&
\prod_{i=1}^{2n}\frac{1}{1-x^i}\prod_{i=1}^n(1-x^{(a_i+1)i})\prod_{i=n+1}^{2n}(1-x^i)
\\=&
\sum_{i=0}^{2n}p_ix^i\prod_{i=1}^n(1-x^{(a_i+1)i})\prod_{i=n+1}^{2n}(1-x^i)
\end{aligned}
$$

注意到题目中的特殊条件 $0\leq a_1<a_2<\cdots<a_n$ 所以 $i\leq a_i+1$

所以 $(a_i+1)i\geq i^2$ 。对于一个确定的 $d$ 一共只有 $\sqrt d$ 种 $i$ 对其有影响，直接暴力算 $p_ix^i$ 对卷积到的位置的贡献

然后 $\prod_{i=n+1}^{2n}(1-x^i)$ 只取前 $2n$ 项系数的时候任意两个选了 $x^i$ 卷起来都超过范围了

可以得到 $\prod_{i=n+1}^{2n}(1-x^i)=1-\sum_{i=n+1}^{2n}x^i$

然后可以卷积这个的时候处理个前缀和直接线性

总复杂度 $O(2n\sqrt{2n}+n\sqrt n+n)=O(n\sqrt n)$

---

### BZOJ4772 显而易见的数论

$$
cnt_{a,b}=
\begin{cases}
&
\sum_{E}\limits\binom{cnt_{a\in E}}{2},&a=b\\
&
\sum_{E}\limits
cnt_a\times cnt_b
,&a\neq b\\
\end{cases}
$$

直接求所有分配方案下每个部分大小为定值的有多少个不好求，**可以转换一下：** 

$$
\begin{aligned}
&\sum_E\limits f(cnt_a)=\sum_E\limits \sum_{i=1}^n f(i)[cnt_a\geq i]
\\
&\sum_E\limits f(cnt_a,cnt_b)=\sum_E\limits \sum_{i=1}^n\sum_{j=1}^n f(i,j)[cnt_a\geq i][cnt_b\geq j]
\end{aligned}
$$

求一个至少有 $i$ 个 $a$ 的划分直接就是 $p(n-ai)$

**搞错了！！！**

上面两个式子都不成立！！！

正确的是

$$
\begin{aligned}
&\sum_E\limits f(cnt_a)=\sum_E\limits \sum_{i=1}^n f(i)[cnt_a=i]=\sum_E\limits \sum_{i=1}^n f(i)[cnt_a\geq i]-\sum_E\limits \sum_{i=1}^n f(i)[cnt_a\geq (i+1)]
\\
&\sum_E\limits cnt_a\times cnt_b=\sum_E\limits \sum_{i=1}^n\sum_{j=1}^n [cnt_a\geq i][cnt_b\geq j]
\end{aligned}
$$

然后求 $g$ 函数

$$
\begin{aligned}
g(p^a)=&\sum_{i=1}^{p^k}[\gcd(i,p^k)=1]\gcd(i-1,p^k)
\\=&
\left(
\sum_{i=1}^{p^k}\gcd(i-1,p^k)
\right)
-
\sum_{i=1}^{p^k}[\gcd(i,p^k)>1]\gcd(i-1,p^k)
\\=&
\left(\sum_{d=0}^{k}p^d\times \varphi(p^{k-d})\right)-p^{k-1}
\\=&
\left(\sum_{d=0}^{k-1}p^d\times (p^{k-d}\times \frac{p-1}{p})\right)
+p^k
-
p^{k-1}
\\=&
k\times p^k\times \frac{p-1}{p}
+p^k
-p^{k-1}
\\=&
k\times p^k-
(k+1)\times p^{k-1}
+p^k
-
p^{k-1}
\\=&
(k+1)\times(p^k-p^{k-1}) 
\end{aligned}
$$

（注意那个 $\gcd=p^k$ 的项来自于 $\gcd(1-1,p^k)=\gcd(0,p^k)=p^k$ ）

考虑两个互质的数的 $g$ 之积

$\gcd(ab,c)=\gcd(a,c)\gcd(b,c)$

$$
\begin{aligned}
g(ab)=&
\sum_{i=1}^{ab}[\gcd(i,ab)=1]\gcd(i-1,ab)
\\=&
\sum_{i=1}^{ab}[\gcd(i,a)=1][\gcd(i,b)=1]\gcd(i-1,a)\gcd(i-1,b)
\\=&
\sum_{i=1}^{ab}[\gcd(i\%a,a)=1][\gcd(i\%b,b)=1]\gcd(i\%a-1,a)\gcd(i\%b-1,b)
\end{aligned}
$$

令 $i\equiv x\pmod a,i\equiv y\pmod b$
因为 $i,j$ 互质，所以每一对不同的 $x,y$ 对应一个唯一的 $1\sim ab$ 的 $i$

$$
\begin{aligned}
&\sum_{i=1}^{ab}[\gcd(x,a)=1][\gcd(y,b)=1]\gcd(x-1,a)\gcd(y-1,b)
\\=&
\sum_{x=1}^{a}\sum_{y=1}^{b}[\gcd(x,a)=1][\gcd(y,b)=1]\gcd(x-1,a)\gcd(y-1,b)
\\=&
\sum_{x=1}^{a}[\gcd(x,a)=1]\gcd(x-1,a)\sum_{y=1}^{b}[\gcd(y,b)=1]\gcd(y-1,b)
\\=&
g(a)g(b)
\end{aligned}
$$

然而在 $g(p^k)=(k+1)\times(p^k-p^{k-1})$ 中可以注意到 $\varphi(p^k)=p^k-p^{k-1}$ 和 $\sigma_0(p^k)=k+1$ 所以 $g(n)=\varphi(n)\times \sigma_0(n)$ 一定是积性函数可以直接证明了

复杂度经过``Wolfram Mathematica`` 算出来是个 $O(n^2PolyLogn)$ 的东西

bzoj 讨论中出题人的写法是枚举 $i,j,x$ 的时候符合要求的 $g[n-i*x-j*y]$ 是一堆等差数列，可以预处理出来，这部分复杂度有保证是 $O(n\log n)$ 的





